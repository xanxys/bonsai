syntax="proto3";
package api;


// Client-Frontend worst connection assumption
// * bandwidth: 1 MB/s
// * latency: 100ms RTT
// * failure rate: once in hour
service FrontendService {
    // Debugging info for entire stack (can break abstraction).
    // Endpoint: /api/debug
    rpc Debug(DebugQ) returns (DebugS);

    // Administrative, read-only.
    // Endpoint: /api/biospheres
    rpc Biospheres(BiospheresQ) returns (BiospheresS);

    // Administrative, write.
    // Endpoint: /api/biosphere_delta
    rpc BiosphereDelta(BiosphereDeltaQ) returns (BiospheresS);

    // In-Biosphere fetching
    // Endpoint: /api/chunk
    rpc Chunk(ChunkQ) returns (ChunkS);

    // Biosphere streaming.
    // Endpoint: /api/biosphere_frames
    rpc BiosphereFrames(BiosphereFramesQ) returns (BiosphereFramesS);
}

// User's authentication information. Some requests requires this to perform
// some operations. Attach them to all requests.
message UserAuth {
    // Google auth API user token id
    // see. https://developers.google.com/identity/sign-in/web/backend-auth
    string id_token = 1;
}

// Error types that are suitable to showing to users, which means:
// * They can be converted to actionable UI.
// When Error is included in response messages, they must be mutually exclusive.
// Response is either:
// 1. OK and contains other fields
// 2. not OK and other fields are garbage
// Exceptions to this rule must be clearly commented.
enum Error {
    // This happens when client is too old.
    // Suggest to refresh the page.
    TOO_OLD_VERSION = 0;

    // User can follow whaterver normal flow.
    OK = 1;

    // Indicates server (including 3rd party backends) failure or system bug.
    // Only thing user can do is randomly retry or wait for a fix.
    // All "shouldn't happen" failures must return this.
    //
    // This includes UI bug: UI that needs authentication must not send requests
    // without id token, for example. Thus, it should result in this error.
    INTERNAL_ERROR = 2;
}

message DebugQ {
    UserAuth auth = 1;
}

message DebugS {

    // Contain error message that is impossible to attribute to each chunk server.
    string chunk_servers_error = 1;

    // Latter entries are always stricter than entries before them.
    enum ChunkServerHealth {
        // The machine shows up in compute engine VM list.
        // This is always true, so this is the default fallback (0).
        ALLOCATED = 0;

        // Possible to create gRPC connection.
        GRPC_OK = 1;

        // Possible to get successful Status RPC response.
        STATUS_OK = 2;
    }

    message ChunkServerState {
        string ip_address = 1;
        // Human-readable state (might be error message when fails to retrieve).
        string state = 2;

        ChunkServerHealth health = 3;
    }
    // Returns all known (including running) chunk server descriptions,
    // excluding already terminated chunk servers.
    repeated ChunkServerState chunk_servers = 2;
}


message BiosphereFramesQ {
    UserAuth auth = 4;

    uint64 biosphere_id = 2;

    bool ensure_start = 3;

    bytes cont_token = 1;
}

// TODO: Level of details sharding
message BiosphereFramesS {
    PolySoup content = 1;
    uint64 content_timestamp = 3;
    bytes cont_token = 2;
}


message BiosphereDeltaQ {
    UserAuth auth = 3;

    //
    DeltaType type = 1;

    // Default values mean no change.
    // In case of ADD, desc.world_id will be ignored.
    BiosphereDesc desc = 2;
}

message BiospheresQ {
    UserAuth auth = 1;
}

message BiospheresS {
    repeated BiosphereDesc biospheres = 1;
}

message ChunkQ {
    ChunkId cid = 1;
    int32 level = 2;

    // Style option should come here.
}

// Target size: 100KB
message ChunkS {
    ChunkId cid = 1;

    int32 level = 2;

    // Triangle soup with vertex colors. Lights are tonemapped and
    // baked in. Color is in LDR space, not physically accurate in any way.
    PolySoup content = 3;
}


enum DeltaType {
    MODIFY = 0;
    ADD = 1;
    DELETE = 2;
}

enum BiosphereState {
    // Should never happen.
    UNKNOWN = 0;

    RUNNING = 1;
    STOPPED = 2;
    // Transition: STOPPED -> RUNNING.
    T_RUN = 3;
    // Transition: RUNNING -> STOPPED.
    T_STOP = 4;
}

message BiosphereDesc {
    uint64 biosphere_id = 1;

    // In UI, it is expected name is single-line, possible descriptive string.
    // e.g. "Biosphere:1/NoBC", "HelloBonsai22 - Guests should use this!"
    string name = 2;

    // How many cores this world is currently configured to use.
    uint32 num_cores = 3;

    // Current timestamp of the world.
    uint64 num_ticks = 4;
}

message PolySoup {
    message Vertex {
        float px = 1;
        float py = 2;
        float pz = 3;

        float nx = 4;
        float ny = 5;
        float nz = 6;

        // LDR color in [0, 1].
        float r = 7;
        float g = 8;
        float b = 9;
    }

    // Vertices of triangles.
    // Length must be multiple of 3.
    repeated Vertex vertices = 1;
}

// This structure is permanent.
// Chunk is 1m * 1m * 10m volume.
message ChunkId {
    // Biosphere-selector.
    uint64 world_id = 1;
    int32 index_x = 2;
    int32 index_y = 3;
}
